# MongoDB Sharding Configuration
# This is a learning/development setup for MongoDB sharding
# 
# Architecture:
# - 3 Config Servers (replica set) - stores cluster metadata
# - 2 Shards (each a 3-node replica set) - stores actual data
# - 2 mongos routers - query routers that applications connect to
#
# Production sharding typically requires:
# - More shards as data grows
# - More mongos routers for high availability
# - Dedicated config servers (not shared with shards)

services:
  # ============================================
  # Config Servers (Replica Set)
  # Stores cluster metadata, shard keys, chunk distribution
  # ============================================
  configsvr1:
    image: mongo:7
    container_name: mobile-app-configsvr1
    restart: unless-stopped
    ports:
      - "27020:27019"  # Config servers use port 27019
    volumes:
      - configsvr1_data:/data/configdb
      - configsvr1_db:/data/db
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: mongod --configsvr --replSet configReplSet --bind_ip_all --port 27019 --keyFile /etc/mongodb-keyfile --auth
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27019/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  configsvr2:
    image: mongo:7
    container_name: mobile-app-configsvr2
    restart: unless-stopped
    ports:
      - "27021:27019"
    volumes:
      - configsvr2_data:/data/configdb
      - configsvr2_db:/data/db
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: mongod --configsvr --replSet configReplSet --bind_ip_all --port 27019 --keyFile /etc/mongodb-keyfile --auth
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27019/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  configsvr3:
    image: mongo:7
    container_name: mobile-app-configsvr3
    restart: unless-stopped
    ports:
      - "27022:27019"
    volumes:
      - configsvr3_data:/data/configdb
      - configsvr3_db:/data/db
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: mongod --configsvr --replSet configReplSet --bind_ip_all --port 27019 --keyFile /etc/mongodb-keyfile --auth
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27019/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ============================================
  # Shard 1 (Replica Set)
  # First shard for data distribution
  # ============================================
  shard1a:
    image: mongo:7
    container_name: mobile-app-shard1a
    restart: unless-stopped
    ports:
      - "27023:27018"
    volumes:
      - shard1a_data:/data/db
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: mongod --shardsvr --replSet shard1 --bind_ip_all --port 27018 --keyFile /etc/mongodb-keyfile --auth
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27018/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  shard1b:
    image: mongo:7
    container_name: mobile-app-shard1b
    restart: unless-stopped
    ports:
      - "27024:27018"
    volumes:
      - shard1b_data:/data/db
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: mongod --shardsvr --replSet shard1 --bind_ip_all --port 27018 --keyFile /etc/mongodb-keyfile --auth
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27018/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  shard1c:
    image: mongo:7
    container_name: mobile-app-shard1c
    restart: unless-stopped
    ports:
      - "27025:27018"
    volumes:
      - shard1c_data:/data/db
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: mongod --shardsvr --replSet shard1 --bind_ip_all --port 27018 --keyFile /etc/mongodb-keyfile --auth
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27018/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ============================================
  # Shard 2 (Replica Set)
  # Second shard for data distribution
  # ============================================
  shard2a:
    image: mongo:7
    container_name: mobile-app-shard2a
    restart: unless-stopped
    ports:
      - "27026:27018"
    volumes:
      - shard2a_data:/data/db
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: mongod --shardsvr --replSet shard2 --bind_ip_all --port 27018 --keyFile /etc/mongodb-keyfile --auth
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27018/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  shard2b:
    image: mongo:7
    container_name: mobile-app-shard2b
    restart: unless-stopped
    ports:
      - "27027:27018"
    volumes:
      - shard2b_data:/data/db
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: mongod --shardsvr --replSet shard2 --bind_ip_all --port 27018 --keyFile /etc/mongodb-keyfile --auth
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27018/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  shard2c:
    image: mongo:7
    container_name: mobile-app-shard2c
    restart: unless-stopped
    ports:
      - "27028:27018"
    volumes:
      - shard2c_data:/data/db
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: mongod --shardsvr --replSet shard2 --bind_ip_all --port 27018 --keyFile /etc/mongodb-keyfile --auth
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27018/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ============================================
  # mongos Routers (Query Routers)
  # Applications connect to mongos, not shards directly
  # ============================================
  mongos1:
    image: mongo:7
    container_name: mobile-app-mongos1
    restart: unless-stopped
    ports:
      - "27017:27017"  # Standard MongoDB port
    depends_on:
      configsvr1:
        condition: service_healthy
      configsvr2:
        condition: service_healthy
      configsvr3:
        condition: service_healthy
      shard1a:
        condition: service_healthy
      shard1b:
        condition: service_healthy
      shard1c:
        condition: service_healthy
      shard2a:
        condition: service_healthy
      shard2b:
        condition: service_healthy
      shard2c:
        condition: service_healthy
    volumes:
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: >
      mongos
      --configdb configReplSet/configsvr1:27019,configsvr2:27019,configsvr3:27019
      --bind_ip_all
      --port 27017
      --keyFile /etc/mongodb-keyfile
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  mongos2:
    image: mongo:7
    container_name: mobile-app-mongos2
    restart: unless-stopped
    ports:
      - "27029:27017"  # Alternative port for second mongos
    depends_on:
      configsvr1:
        condition: service_healthy
      configsvr2:
        condition: service_healthy
      configsvr3:
        condition: service_healthy
      shard1a:
        condition: service_healthy
      shard1b:
        condition: service_healthy
      shard1c:
        condition: service_healthy
      shard2a:
        condition: service_healthy
      shard2b:
        condition: service_healthy
      shard2c:
        condition: service_healthy
    volumes:
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    command: >
      mongos
      --configdb configReplSet/configsvr1:27019,configsvr2:27019,configsvr3:27019
      --bind_ip_all
      --port 27017
      --keyFile /etc/mongodb-keyfile
    networks:
      - mobile-app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # ============================================
  # Sharding Initialization Script
  # Sets up replica sets and adds shards to cluster
  # Note: This runs automatically on first startup
  # ============================================
  mongodb-sharding-init:
    image: mongo:7
    container_name: mobile-app-mongodb-sharding-init
    depends_on:
      configsvr1:
        condition: service_healthy
      configsvr2:
        condition: service_healthy
      configsvr3:
        condition: service_healthy
      shard1a:
        condition: service_healthy
      shard1b:
        condition: service_healthy
      shard1c:
        condition: service_healthy
      shard2a:
        condition: service_healthy
      shard2b:
        condition: service_healthy
      shard2c:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts
      - ./mongodb-keyfile:/etc/mongodb-keyfile:ro
    working_dir: /scripts
    networks:
      - mobile-app-network
    command: >
      sh -c "
        chmod +x /scripts/init-sharding.sh &&
        /scripts/init-sharding.sh
      "
    restart: "no"

  # ============================================
  # Redis (still needed for caching and queues)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: mobile-app-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - mobile-app-network
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # Server instances (connect to mongos, not shards)
  # ============================================
  server1:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: mobile-app-server1
    restart: unless-stopped
    environment:
      PORT: 3000
      # Connect to mongos routers, not shards directly
      # Update with credentials after running init-sharding-auth.sh
      MONGODB_URI: mongodb://appuser:apppass123@mongos1:27017,mongos2:27017/mobileapp?authSource=admin
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-this-secret-key-in-production-use-openssl-rand-base64-32}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      NODE_ENV: ${NODE_ENV:-production}
      SERVER_INSTANCE: server1
    env_file:
      - .env
    depends_on:
      mongos1:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - mobile-app-network
    volumes:
      - ./server:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  server2:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: mobile-app-server2
    restart: unless-stopped
    environment:
      PORT: 3000
      MONGODB_URI: mongodb://mongos1:27017,mongos2:27017/mobileapp
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-this-secret-key-in-production-use-openssl-rand-base64-32}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      NODE_ENV: ${NODE_ENV:-production}
      SERVER_INSTANCE: server2
    env_file:
      - .env
    depends_on:
      mongos1:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - mobile-app-network
    volumes:
      - ./server:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  server3:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: mobile-app-server3
    restart: unless-stopped
    environment:
      PORT: 3000
      MONGODB_URI: mongodb://mongos1:27017,mongos2:27017/mobileapp
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-this-secret-key-in-production-use-openssl-rand-base64-32}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      NODE_ENV: ${NODE_ENV:-production}
      SERVER_INSTANCE: server3
    env_file:
      - .env
    depends_on:
      mongos1:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - mobile-app-network
    volumes:
      - ./server:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================
  # Load Balancer
  # ============================================
  loadbalancer:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: mobile-app-loadbalancer
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      server1:
        condition: service_healthy
      server2:
        condition: service_healthy
      server3:
        condition: service_healthy
    networks:
      - mobile-app-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================
  # Worker Service
  # ============================================
  worker:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: mobile-app-worker
    restart: unless-stopped
    environment:
      MONGODB_URI: mongodb://mongos1:27017,mongos2:27017/mobileapp
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-this-secret-key-in-production-use-openssl-rand-base64-32}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      NODE_ENV: ${NODE_ENV:-production}
    env_file:
      - .env
    depends_on:
      mongos1:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - mobile-app-network
    volumes:
      - ./server:/app
      - /app/node_modules
    command: npm run worker
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[w]orker.js' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  # Config server volumes
  configsvr1_data:
  configsvr1_db:
  configsvr2_data:
  configsvr2_db:
  configsvr3_data:
  configsvr3_db:
  # Shard 1 volumes
  shard1a_data:
  shard1b_data:
  shard1c_data:
  # Shard 2 volumes
  shard2a_data:
  shard2b_data:
  shard2c_data:
  # Redis volume
  redis_data:

networks:
  mobile-app-network:
    driver: bridge

